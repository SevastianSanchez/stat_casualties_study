---
title: "Stage 2 (Article)"
author: "Sevastian Sanchez"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: no
    toc_depth: '3'
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: yes
    highlight: tango
    theme: default
    fig_caption: yes
    df_print: tibble
  word_document: default
  urlcolor: blue
---
```{r}
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE,
  tidy = TRUE, tidy.opts = list(width.cutoff = 60) 
)
```

# Set up
```{r}
# set working directory
setwd("~/Documents/GitHub/stat_casualties_study")

#load libraries/packages
source("packages.R")

# load data
source("Comp2_panel_wrangling.R")

# select relevant variables and arrange data
panel_data1 <- panel_data %>% 
  dplyr::select(country_name, country_code, year, sdg_overall, spi_comp, 
                di_score, log_gdppc, income_level_recoded) %>%
  dplyr::arrange(country_code, year)

# how many countries 
length(unique(panel_data1$country_code)) # should be 162 countries
```

## Converting to panel data frame
```{r}
panel_data <- pdata.frame(panel_data1, index = c("country_code", "year"))
pdim(panel_data) # check panel dimensions
```

# Direct Effect: SDG ~ DI

## Model POLS: Basic model with DI as predictor and SPI ommitted
```{r}
# Model POLS: Basic FE model with DI as predictor
model_pols <- plm(formula = sdg_overall ~ di_score
              + plm::lag(di_score, 1) 
              + plm::lag(di_score, 2) 
              + log_gdppc 
              + factor(year),
              data = panel_data,
              model = "pooling")
summary(model_pols, vcov = vcovHC(model_pols, cluster = "group", type = "HC1"))
```

## DIRECT FD MODEL: Basic model with DI as predictor and SPI ommitted
```{r}
# Contemporaneous Effects: SDG ~ DI [REPORTED]
fd_dir_current <- plm(formula = sdg_overall ~ di_score
              + log_gdppc
              + factor(year),
              data = panel_data,
              model = "fd")
summary(fd_dir_current, vcov = vcovHC(fd_dir_current, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI [REPORTED]
fd_dir_dynamic <- plm(formula = sdg_overall ~ di_score
              + plm::lag(di_score, 1) 
              + plm::lag(di_score, 2) 
              + log_gdppc
              + factor(year),
              data = panel_data,
              model = "fd")
summary(fd_dir_dynamic, vcov = vcovHC(fd_dir_dynamic, cluster = "group", type = "HC1"))

# ensure correct names 
# names(coef(fd_dir_dynamic))

# joint significance - FD
linearHypothesis(
  fd_dir_dynamic,
  c("di_score", 
    "plm::lag(di_score, 1)",
    "plm::lag(di_score, 2)"),
  vcov. = vcovHC(fd_dir_dynamic, cluster = "group", type = "HC1"),
  test = "F"
)

# cumulative effect - FD
linearHypothesis(
  fd_dir_dynamic,
  c("di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fd_dir_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# CI for Direct FD model with Lag2
coef <- coef(fd_dir_dynamic)
se <- sqrt(diag(vcovHC(fd_dir_dynamic, cluster = "group", type = "HC1")))  # Get standard errors
crit_value <- qt(0.975, df = nobs(fd_dir_dynamic)-length(coef(fd_dir_dynamic)))
ci_low_fd <- coef - crit_value * se
ci_high_fd <- coef + crit_value * se
cbind(ci_low_fd, ci_high_fd)
```
**Results:** The joint significance tests for FD show no evidence that DI variables are jointly significant in explaining changes in SDG overall scores (Chisq = 4.3277, p = 0.2282). This suggests that DI may not have a meaningful immediate impact on SDG outcomes when considering both current and lagged effects.

In terms of *cumulative impact*, based on the FD model and panel data, showed no evidence of cumulative total impacts of changes in di_score (at current, lag 1, or lag 2) on SPI —over these periods (stat = 2e-04, p = 0.9879).

## DIRECT TWFE MODEL: Basic model with DI as predictor and SPI ommitted
```{r}
# Contemporaneous Effects: SDG ~ DI [REPORTED]
twfe_dir_current <- plm(formula = sdg_overall ~ di_score
              + log_gdppc 
              + factor(year),
              data = panel_data,
              model = "within")
summary(twfe_dir_current, vcov = vcovHC(twfe_dir_current, cluster = "group", type = "HC1"))

# Adding Lag2: SDG ~ DI [REPORTED]
twfe_dir_dynamic <- plm(formula = sdg_overall ~ di_score
              + plm::lag(di_score, 1) 
              + plm::lag(di_score, 2)
              + log_gdppc 
              + factor(year),
              data = panel_data,
              model = "within")
summary(twfe_dir_dynamic, vcov = vcovHC(twfe_dir_dynamic, cluster = "group", type = "HC1"))

# joint significance - FE
linearHypothesis(
  twfe_dir_dynamic,
  c("di_score = 0", "plm::lag(di_score, 1) = 0", "plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(twfe_dir_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)
# ensure correct names 
# names(coef(twfe_dir_dynamic))

# cumulative effect - FE
linearHypothesis(
  twfe_dir_dynamic,
  c("di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(twfe_dir_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# CI for FE model with Lag2
coef <- coef(twfe_dir_dynamic)
se <- sqrt(diag(vcovHC(twfe_dir_dynamic, cluster = "group", type = "HC1")))  # Get standard errors
crit_value <- qt(0.975, df = nobs(twfe_dir_dynamic)-length(coef(twfe_dir_dynamic)))
ci_low_twfe <- coef - crit_value * se
ci_high_twfe <- coef + crit_value * se
cbind(ci_low_twfe, ci_high_twfe)
```
**Result:** The joint significance tests for FE show that the DI variables are jointly significant in explaining changes in SDG overall scores (F = 2.6245, p = 0.04947). 

In terms of *cumulative impact*, based on the FE model and panel data, results detected a total impact of changes in di_score (at current, lag 1, or lag 2) on SPI —over these periods (stat = 0.3742, p = 0.5407)

# Mediation Effect: SDG ~ DI via SPI

## Model POLS: SDG ~ DI + SPI 
```{r}
# Adding Lag2: SPI ~ DI
ols_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp + plm::lag(spi_comp, 1) 
                      + plm::lag(spi_comp, 2) + di_score + plm::lag(di_score, 1) 
                      + plm::lag(di_score, 2) + log_gdppc 
                      #+ factor(income_level_recoded) 
                      + factor(year), 
               model = "pooling", 
               data = panel_data)
summary(ols_sdg_spi_L2, vcov = vcovHC(ols_sdg_spi_L2, cluster = "group", type = "HC1"))

## UNIT TEST 
# Checking which countries are dropped due to missingness
# Rows actually used in the model
model_rows <- rownames(model.frame(ols_sdg_spi_L2))
used_ids <- unique(panel_data[model_rows, "country_code"])
dropped_ids <- setdiff(unique(panel_data1$country_code), used_ids)

length(used_ids)      # should be 155
length(dropped_ids)   # should be 7
dropped_ids           # which countries are excluded
```

## FD MEDIATION MODEL: SDG ~ DI + SPI 
```{r}
# Contemporaneous Effects: SDG ~ DI + SPI [REPORTED]
fd_med_current <- plm(formula = sdg_overall ~ spi_comp 
                     + di_score 
                     + log_gdppc
                     + factor(year),
               model = "fd", 
               data = panel_data)
summary(fd_med_current, vcov = vcovHC(fd_med_current, cluster = "group", type = "HC1"))

# Adding Lag2: SDG ~ DI + SPI [REPORTED]
fd_med_dynamic <- plm(formula = sdg_overall ~ spi_comp 
                     + plm::lag(spi_comp, 1) 
                     + plm::lag(spi_comp, 2) 
                     + di_score 
                     + plm::lag(di_score, 1) 
                     + plm::lag(di_score, 2) 
                     + log_gdppc
                     + factor(year),
               model = "fd", 
               data = panel_data)
summary(fd_med_dynamic, vcov = vcovHC(fd_med_dynamic, cluster = "group", type = "HC1"))

# ensure correct names 
# names(coef(fd_med_dynamic))

# Joint significance - MEDIATION, FIRST DIFFERENCE, X = DI
linearHypothesis(
  fd_med_dynamic,
  c("di_score = 0", "plm::lag(di_score, 1) = 0", "plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fd_med_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# cumulative effects - MEDIATION, FIRST DIFFERENCE, X = DI
linearHypothesis(
  fd_med_dynamic,
  c("di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fd_med_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# Joint significance, MEDIATION, FIRST DIFFERENCE, Z = SPI
linearHypothesis(
  fd_med_dynamic,
  c("spi_comp = 0", "plm::lag(spi_comp, 1) = 0", "plm::lag(spi_comp, 2) = 0"),
  vcov. = vcovHC(fd_med_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# cumulative effects - MEDIATION, FIRST DIFFERENCE, Z = SPI
linearHypothesis(
  fd_med_dynamic,
  c("spi_comp + plm::lag(spi_comp, 1) + plm::lag(spi_comp, 2) = 0"),
  vcov. = vcovHC(fd_med_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# CIs
coef <- coef(fd_med_dynamic)
se <- sqrt(diag(vcovHC(fd_med_dynamic, cluster = "group", type = "HC1")))  # Get standard errors
crit_value <- qt(0.975, df = nobs(fd_med_dynamic)-length(coef(fd_med_dynamic)))
ci_low_fd_med <- coef - crit_value * se
ci_high_fd_med <- coef + crit_value * se
cbind(ci_low_fd_med, ci_high_fd_med)
```
**Result (DI Variables):** The *joint significance* tests for FD show no evidence that DI variables are jointly significant in explaining changes in SDG overall scores (Chisq = 5.9731, p = 0.1129), holding SPI terms and all else constant. This suggests that shifts in democracy levels may not have a meaningful immediate impact on SDG performance when considering both current and lagged effects, and accounting for SPI and other controls.

In terms of *cumulative impact*, based on the FD model and panel data, there is no detectable total impact of changes in di_score (at current, lag 1, or lag 2) on SDG performance—over these periods (stat = 0.3872, p = 0.5338).

**Result (SPI Variables):** The *joint significance* tests for FD show marginal evidence that SPI variables are jointly significant in explaining changes in SDG overall scores (Chisq = 7.2282, alpha = 0.1, p = 0.06497), holding DI terms and all else constant. This suggests that shifts in statistical capacity may negligibly have a legitimate immediate impact on SDG performance when considering both current and lagged effects, and accounting for DI and other controls.

In terms of *cumulative impact*, based on the FD model and panel data, there is a detectable total impact of changes in spi_comp (at current, lag 1, or lag 2) on SDG performance—over these periods (stat = 6.4111, p = 0.01134)

## TWFE MEDIATION MODEL: SDG ~ DI + SPI 
```{r}
# Contemporaneous Effects: SDG ~ DI + SPI [REPORTED]
twfe_sdg_spi_current <- plm(formula = sdg_overall ~ spi_comp 
                     + di_score 
                     + log_gdppc 
                     + factor(year), 
               model = "within", 
               data = panel_data)
summary(twfe_sdg_spi_current, vcov = vcovHC(twfe_sdg_spi_current, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
twfe_med_dynamic <- plm(formula = sdg_overall ~ spi_comp 
                     + plm::lag(spi_comp, 1) 
                     + plm::lag(spi_comp, 2) 
                     + di_score 
                     + plm::lag(di_score, 1) 
                     + plm::lag(di_score, 2) 
                     + log_gdppc 
                     + factor(year), 
               model = "within", 
               data = panel_data)
summary(twfe_med_dynamic, vcov = vcovHC(twfe_med_dynamic, cluster = "group", type = "HC1"))

# ensure correct names 
# names(coef(twfe_med_dynamic))

# Joint significance - MEDIATION, TW FIXED EFFECTS, X = DI
linearHypothesis(
  twfe_med_dynamic,
  c("di_score = 0", "plm::lag(di_score, 1) = 0", "plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(twfe_med_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# cumulative effects - MEDIATION, TW FIXED EFFECTS, X = DI
linearHypothesis(
  twfe_med_dynamic,
  c("di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(twfe_med_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# Joint significance - MEDIATION, TW FIXED EFFECTS, Z = SPI
linearHypothesis(
  twfe_med_dynamic,
  c("spi_comp = 0", "plm::lag(spi_comp, 1) = 0", "plm::lag(spi_comp, 2) = 0"),
  vcov. = vcovHC(twfe_med_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# cumulative effects - MEDIATION, TW FIXED EFFECTS, Z = SPI
linearHypothesis(
  twfe_med_dynamic,
  c("spi_comp + plm::lag(spi_comp, 1) + plm::lag(spi_comp, 2) = 0"),
  vcov. = vcovHC(twfe_med_dynamic, cluster = "group", type = "HC1"), 
  test = "F"
)

# CI for all variables (L2 model)
coef <- coef(twfe_med_dynamic)
se <- sqrt(diag(vcovHC(twfe_med_dynamic, cluster = "group", type = "HC1")))  # Get standard errors
crit_value <- qt(0.975, df = nobs(twfe_med_dynamic)-length(coef(twfe_med_dynamic)))
ci_low_twfe_med <- coef - crit_value * se
ci_high_twfe_med <- coef + crit_value * se
cbind(ci_low_twfe_med, ci_high_twfe_med)
```
**Result (DI Variables):** The *joint significance* tests for FE show evidence that DI variables are jointly significant in explaining changes in SDG overall scores (Chisq = 10.873, p = 0.01244), holding SPI terms and all else constant. This suggests that shifts in democracy levels have a meaningful incremental impact on SDG performance when considering both current and lagged effects, and accounting for SPI and other controls.

In terms of *cumulative impact*, based on the FE model and panel data, there is no detectable total impact of changes in di_score (at current, lag 1, or lag 2) on SDG performance—over these periods (stat = 0.4482, p = 0.5032).

Interestingly, this suggest that the effect is not consistent over time, with short term impacts lasting up to 2 years, but not accumulating over time.

**Result (SPI Variables):** The *joint significance* tests for FE show evidence that SPI variables are jointly significant in explaining changes in SDG overall scores (F = 10.214, p = 0.01683), holding DI terms and all else constant. This suggests that shifts in statistical capacity have a legitimate incremental impact on SDG performance when considering both current and lagged effects, and accounting for DI and other controls.

In terms of *cumulative impact*, based on the FE model and panel data, there is relatively stong evidence of detectable total impact of changes in spi_comp (at current, lag 1, or lag 2) on SDG performance—over these periods (stat = 9.3778, p = 0.002196 **)

## COMPILING MODLE RESULTS FOR VISUALIZATIONS ##
```{r}
# Creating one dataframe for all visualizations 

# FD Direct Effects
coefs_fd_direct <- summary(fd_dir_dynamic, vcov = vcovHC(fd_dir_dynamic, cluster = "group", type = "HC1"))$coefficients
coef_df_fd_direct <- data.frame(
  model = "FD_Direct",
  term = rownames(coefs_fd_direct),
  estimate = coefs_fd_direct[, "Estimate"],
  std.error = coefs_fd_direct[, "Std. Error"],
  ci_low = coefs_fd_direct[, "Estimate"] - 1.96 * coefs_fd_direct[, "Std. Error"],
  ci_high = coefs_fd_direct[, "Estimate"] + 1.96 * coefs_fd_direct[, "Std. Error"]
)

# FD Mediation Effects
coefs_fd_med <- summary(fd_med_dynamic, vcov = vcovHC(fd_med_dynamic, cluster = "group", type = "HC1"))$coefficients
coef_df_fd_med <- data.frame(
  model = "FD_Mediation",
  term = rownames(coefs_fd_med),
  estimate = coefs_fd_med[, "Estimate"],
  std.error = coefs_fd_med[, "Std. Error"],
  ci_low = coefs_fd_med[, "Estimate"] - 1.96 * coefs_fd_med[, "Std. Error"],
  ci_high = coefs_fd_med[, "Estimate"] + 1.96 * coefs_fd_med[, "Std. Error"]
)

# TWFE Direct Effects
coefs_twfe_direct <- summary(twfe_dir_dynamic, vcov = vcovHC(twfe_dir_dynamic, cluster = "group", type = "HC1"))$coefficients
coef_df_twfe_direct <- data.frame(
  model = "TWFE_Direct",
  term = rownames(coefs_twfe_direct),
  estimate = coefs_twfe_direct[, "Estimate"],
  std.error = coefs_twfe_direct[, "Std. Error"],
  ci_low = coefs_twfe_direct[, "Estimate"] - 1.96 * coefs_twfe_direct[, "Std. Error"],
  ci_high = coefs_twfe_direct[, "Estimate"] + 1.96 * coefs_twfe_direct[, "Std. Error"]
)

# TWFE Mediation Effects
coefs_twfe_med <- summary(twfe_med_dynamic, vcov = vcovHC(twfe_med_dynamic, cluster = "group", type = "HC1"))$coefficients
coef_df_twfe_med <- data.frame(
  model = "TWFE_Mediation",
  term = rownames(coefs_twfe_med),
  estimate = coefs_twfe_med[, "Estimate"],
  std.error = coefs_twfe_med[, "Std. Error"],
  ci_low = coefs_twfe_med[, "Estimate"] - 1.96 * coefs_twfe_med[, "Std. Error"],
  ci_high = coefs_twfe_med[, "Estimate"] + 1.96 * coefs_twfe_med[, "Std. Error"]
)

# Combine all into one dataframe
stage2_model_results <- rbind(coef_df_fd_direct, coef_df_fd_med, coef_df_twfe_direct, coef_df_twfe_med)

# View combined results
head(stage2_model_results)

# Save combined results for future use
write.csv(stage2_model_results, "panel_regression/model_results/stage2_model_results.csv", 
          row.names = FALSE)
```

### MEDIATION FD ERROR BAR
```{r}
# Filtering for FD Mediation model and selecting only DI and SPI variables
sub_model <- stage2_model_results %>%
  filter(model == "FD_Mediation",
         term %in% c("di_score", 
                     "plm::lag(di_score, 1)", 
                     "plm::lag(di_score, 2)", 
                     "spi_comp",
                     "plm::lag(spi_comp, 1)",
                     "plm::lag(spi_comp, 2)"))

# Create a ggplot error bar chart for the FD model
ebar_fd <- ggplot(sub_model, aes(x = term, y = estimate)) +
  geom_point() +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "steelblue") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), 
                width = 0.2) +
  labs(title = "Stage II: Static & Dynamic FD (SDG ~ SPI + DI)",
       x = NULL,
       y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_discrete(labels = c("di_score" = "Democracy (DI)", 
                              "plm::lag(di_score, 1)" = "Lagged DI (t-1)", 
                              "plm::lag(di_score, 2)" = "Lagged DI (t-2)", 
                              "spi_comp" = "Statistical Performance (SPI)",
                              "plm::lag(spi_comp, 1)" = "Lagged SPI (t-1)",
                              "plm::lag(spi_comp, 2)" = "Lagged SPI (t-2)"
                              ),
                   limits = c(
                   "spi_comp",
                   "plm::lag(spi_comp, 1)",
                   "plm::lag(spi_comp, 2)",
                   "di_score", 
                   "plm::lag(di_score, 1)",
                   "plm::lag(di_score, 2)"
                 ))

ebar_fd

# Save the plot
ggsave("panel_regression/figures/stage2/error_bar_fd_med_dynamic.png", ebar_fd, width = 10, height = 6)
```

### MEDIATION TWFE ERROR BAR
```{r}
sub_model <- stage2_model_results %>%
  filter(model == "TWFE_Mediation",
         term %in% c("di_score", 
                     "plm::lag(di_score, 1)", 
                     "plm::lag(di_score, 2)", 
                     "spi_comp",
                     "plm::lag(spi_comp, 1)",
                     "plm::lag(spi_comp, 2)"))

# Create a ggplot error bar chart
ebar_fe <- ggplot(sub_model, aes(x = term, y = estimate)) +
  geom_point() +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "steelblue") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), 
                width = 0.2) +
  labs(title = "Stage II: Static & Dynamic TWFE (SDG ~ SPI + DI)",
       x = NULL,
       y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(hjust = 1)) +
  scale_x_discrete(labels = c("di_score" = "Democracy (DI)", 
                              "plm::lag(di_score, 1)" = "Lagged DI (t-1)", 
                              "plm::lag(di_score, 2)" = "Lagged DI (t-2)", 
                              "spi_comp" = "Statistical Performance (SPI)",
                              "plm::lag(spi_comp, 1)" = "Lagged SPI (t-1)",
                              "plm::lag(spi_comp, 2)" = "Lagged SPI (t-2)"
                              ),
                   limits = c(
                   "spi_comp",
                   "plm::lag(spi_comp, 1)",
                   "plm::lag(spi_comp, 2)",
                   "di_score", 
                   "plm::lag(di_score, 1)",
                   "plm::lag(di_score, 2)"
                 ))

ebar_fe

# Save the plot
ggsave("panel_regression/figures/stage2/error_bar_twfe_med_dynamic.png", ebar_fe, width = 10, height = 6)
```

## DYNAMIC IMPACTS VISUALIZATIONS ##

## DIRECT EFFECTS DYNAMIC IMPACT VIZ 
Forward looking visualization 
```{r}
# Extract DI coefficients only (exclude log_gdppc)
fd_di_data <- stage2_model_results %>%
  filter(model == "FD_Direct",
    term %in% c("di_score", "plm::lag(di_score, 1)", "plm::lag(di_score, 2)")) %>% 
  arrange(desc(term))

twfe_di_data <- stage2_model_results %>%
  filter(model == "TWFE_Direct",
    term %in% c("di_score", "plm::lag(di_score, 1)", "plm::lag(di_score, 2)")) %>% 
  arrange(desc(term))

# Extract coefficients and standard errors
fd_coef_de <- fd_di_data$estimate
twfe_coef_de <- twfe_di_data$estimate

fd_se_de <- fd_di_data$std.error
twfe_se_de <- twfe_di_data$std.error

# Calculate 95% CIs for instantaneous effects
fd_lower <- fd_di_data$ci_low
fd_upper <- fd_di_data$ci_high

twfe_lower <- twfe_di_data$ci_low
twfe_upper <- twfe_di_data$ci_high

# Calculate cumulative effects
fd_cumul <- cumsum(fd_coef_de)
twfe_cumul <- cumsum(twfe_coef_de)

# Calculate cumulative CIs (uncertainty compounds)
# For cumulative: Var(sum) = sum of variances (assuming independence)
fd_cumul_se <- sqrt(cumsum(fd_se_de^2))
fd_cumul_lower <- fd_cumul - 1.96 * fd_cumul_se
fd_cumul_upper <- fd_cumul + 1.96 * fd_cumul_se

twfe_cumul_se <- sqrt(cumsum(twfe_se_de^2))
twfe_cumul_lower <- twfe_cumul - 1.96 * twfe_cumul_se
twfe_cumul_upper <- twfe_cumul + 1.96 * twfe_cumul_se

# Create data frames
periods <- c(0, 1, 2)
period_labels <- c("Year 0", "Year 1", "Year 2")

# Instantaneous effects data
instant_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_coef_de, twfe_coef_de),
  lower = c(fd_lower, twfe_lower),
  upper = c(fd_upper, twfe_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Cumulative effects data
cumul_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_cumul, twfe_cumul),
  lower = c(fd_cumul_lower, twfe_cumul_lower),
  upper = c(fd_cumul_upper, twfe_cumul_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Plot 1: Instantaneous Effects
p1_de <- ggplot(instant_data, aes(x = factor(period, labels = period_labels), 
                                y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Year 0", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "Time Since Democracy Shift", 
       y = "Effect per Period",
       title = "Period-Specific Effects (Direct Models)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Plot 2: Cumulative Effects
p2_de <- ggplot(cumul_data, aes(x = factor(period, labels = period_labels), 
                              y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Year 0", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "Time Since Democracy Shift", 
       y = "Cumulative Effect",
       title = "Cumulative Effects Over Time (Direct Models)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Combine plots
combined_plot_de <- p1_de + p2_de + 
  plot_layout(guides = "collect") +
  plot_annotation(title = "Dynamic Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins around each subplot
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot_de

# Save normally
ggsave("panel_regression/figures/stage2/direct_effects/combined_dynamic_effects_dir_s2_color.png", 
       plot = combined_plot_de, 
       width = 12, height = 6)

################# Creating + saving black and white version #################
p1_de_bw <- p1_de +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))
p2_de_bw <- p2_de +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))

#  Combine bw plots 
combined_plot_de_bw <- p1_de_bw + p2_de_bw +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Dynamic Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins around each subplot
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot_de_bw

# Save bw version 
ggsave("panel_regression/figures/stage2/direct_effects/combined_dynamic_effects_dir_s2_bw.png", 
       plot = combined_plot_de_bw, 
       width = 12, height = 6)
```

### MEDIATION EFFECTS DYNAMIC IMPACT VIZ: SPI CONTROL APPLIED
Forward looking vizualization 
```{r}
# Extract DI coefficients only (exclude log_gdppc)
fd_med_data <- stage2_model_results %>%
  filter(model == "FD_Mediation",
    term %in% c("di_score", "plm::lag(di_score, 1)", "plm::lag(di_score, 2)")) %>% 
  arrange(desc(term))

twfe_med_data <- stage2_model_results %>%
  filter(model == "TWFE_Mediation",
    term %in% c("di_score", "plm::lag(di_score, 1)", "plm::lag(di_score, 2)")) %>% 
  arrange(desc(term))

# Extract coefficients and standard errors
fd_coef_me <- fd_med_data$estimate
twfe_coef_me <- twfe_med_data$estimate

fd_se_me <- fd_med_data$std.error
twfe_se_me <- twfe_med_data$std.error

# Calculate 95% CIs for instantaneous effects
fd_lower <- fd_med_data$ci_low
fd_upper <- fd_med_data$ci_high

twfe_lower <- twfe_med_data$ci_low
twfe_upper <- twfe_med_data$ci_high

# Calculate cumulative effects
fd_cumul <- cumsum(fd_coef_me)
twfe_cumul <- cumsum(twfe_coef_me)

# Calculate cumulative CIs (uncertainty compounds)
# For cumulative: Var(sum) = sum of variances (assuming independence)
fd_cumul_se <- sqrt(cumsum(fd_se_me^2))
fd_cumul_lower <- fd_cumul - 1.96 * fd_cumul_se
fd_cumul_upper <- fd_cumul + 1.96 * fd_cumul_se

twfe_cumul_se <- sqrt(cumsum(twfe_se_me^2))
twfe_cumul_lower <- twfe_cumul - 1.96 * twfe_cumul_se
twfe_cumul_upper <- twfe_cumul + 1.96 * twfe_cumul_se

# Create data frames
periods <- c(0, 1, 2)
period_labels <- c("Year 0", "Year 1", "Year 2")

# Instantaneous effects data
instant_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_coef_me, twfe_coef_me),
  lower = c(fd_lower, twfe_lower),
  upper = c(fd_upper, twfe_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Cumulative effects data
cumul_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_cumul, twfe_cumul),
  lower = c(fd_cumul_lower, twfe_cumul_lower),
  upper = c(fd_cumul_upper, twfe_cumul_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Plot 1: Instantaneous Effects
p1_me <- ggplot(instant_data, aes(x = factor(period, labels = period_labels), 
                                y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Year 0", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "Time Since Democracy Shift", 
       y = "Effect per Period",
       title = "Period-Specific Effects (Mediation Models)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Plot 2: Cumulative Effects
p2_me <- ggplot(cumul_data, aes(x = factor(period, labels = period_labels), 
                              y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Year 0", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "Time Since Democracy Shift", 
       y = "Cumulative Effect",
       title = "Cumulative Effects Over Time (Mediation Models)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Combine plots
combined_plot_me <- p1_me + p2_me + 
  plot_layout(guides = "collect") +
  plot_annotation(title = "Dynamic Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot_me

# Save normally
ggsave("panel_regression/figures/stage2/combined_dynamic_effects_me_s2_color.png", 
       plot = combined_plot_me, 
       width = 12, height = 6)

################# Creating + saving black and white version #################
p1_me_bw <- p1_me +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))
p2_me_bw <- p2_me +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))

#  Combine bw plots 
combined_plot_me_bw <- p1_me_bw + p2_me_bw +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Dynamic Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins 
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot_me_bw

# Save bw version 
ggsave("panel_regression/figures/stage2/combined_dynamic_effects_me_s2_bw.png", 
       plot = combined_plot_de_bw, 
       width = 12, height = 6)
```

## ALL TOGETHER: DIRECT + MEDIATION EFFECTS ##
```{r}
### Creating + saving black and white version
p1_me_bw <- p1_me_bw +
  labs(x = "Time Since Democracy Increase", y = "Effect per Period")
p2_me_bw <- p2_me_bw +
  labs(x = "Time Since Democracy Increase", y = "Cumulative Effect")

### ALL TOGETHER: DIRECT + MEDIATION EFFECTS ###
combined_s2_bw <- (p1_de_bw | p2_de_bw) / (p1_me_bw | p2_me_bw) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Direct & Mediation Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)", 
    subtitle = "Comparing effects over time with and without SPI mediator",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 18),
      plot.subtitle = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins 
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_s2_bw

# Save bw version
ggsave("panel_regression/figures/stage2/combined_dynamic_effects_s2_all_bw.png", 
       plot = combined_s2_bw, 
       width = 12, height = 9)
```

### Stargazer table for Direct Effects models (Lag2)
```{r eval=FALSE, include=FALSE}
rob_se_total_ef <- list(
  sqrt(diag(vcovHC(fd_dir_current, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fd_dir_dynamic, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(twfe_dir_current, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(twfe_dir_dynamic, cluster = "group", type = "HC1"))) 
)
# Generate the stargazer table for Lag2 models
stargazer(fd_dir_current, fd_dir_dynamic, twfe_dir_current, twfe_dir_dynamic, 
          se = rob_se_total_ef,
          title = "Stage II Models (Direct Effect): Contemporaneous & Dynamic Effects (SDG ~ DI)",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("FD", "FD", "TWFE", "TWFE"),
          covariate.labels = c("Democracy Index (DI) (Composite)", "Lagged DI (t-1)", "Lagged DI (t-2)", "(Log) GDP per-capita", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "panel_regression/figures/stage2/direct_effects/dir_effect_mods.html")
```

### stargazer table of all Mediation Effects models (Lag2)
```{r eval=FALSE, include=FALSE}
# Extracting robust standard errors for the three models
rob_se_med_mods <- list(
  sqrt(diag(vcovHC(fd_med_current, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fd_med_dynamic, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fe_sdg_spi_current, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(twfe_med_dynamic, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for Lag2 models
stargazer(fd_med_current, fd_med_dynamic, fe_sdg_spi_current, twfe_med_dynamic, 
          se = rob_se_med_mods,
          title = "Stage II Models (Mediation): Contemporaneous & Dynamic Effects (SDG ~ DI + SPI)",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("FD", "FD", "TWFE", "TWFE"),
          covariate.labels = c("Statistical Performance Index (SPI) (Composite)", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "Democracy Index (DI) (Composite)", "Lagged DI (t-1)", "Lagged DI (t-2)", "(Log) GDP per-capita", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          ##keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)", # Omits year FE from display
          out = "panel_regression/figures/stage2/med_effect_mods.html")
```


## Check for Autocorrelation 
```{r}
# APPLY Wooldridge Test for AR(1) Errors in FE Panel Models: pwartest()
# https://search.r-project.org/CRAN/refmans/plm/html/pwartest.html  
# This is MUCH BETTER for panel data with small T AND unbalanced panels!!!
pbgtest(twfe_med_dynamic) # Panel
pwartest(twfe_med_dynamic) # FE [significant]
pwfdtest(fd_med_dynamic) # FD [significant]
```
Significant p-value indicates the presence of autocorrelation in the residuals of the fixed effects model. This suggests that the errors are correlated over time, which violates one of the key assumptions of linear regression models.

## Check for Heteroskedasticity
```{r}
# Apply Breusch-Pagan test for heteroskedasticity
bptest(twfe_med_dynamic, studentize = TRUE) # Heteroskedasticity [significant]
bptest(fd_med_dynamic, studentize = TRUE) # Heteroskedasticity [significant]
```
The Breusch-Pagan test indicates the presence of heteroskedasticity in the residuals of the fixed effects model. This suggests that the variance of the errors is not constant across observations. 

Both violations are corrected by using robust standard errors clustered at the country level, which accounts for autocorrelation and heteroskedasticity.

## TESTING CLUSTARD ROBUST SE'S FROM OTHER PACKAGE:
```{r}
# [SOMETHING IS WRONG]
library(clubSandwich)

# Cluster-robust inference
results_CR1 <- coef_test(twfe_dir_dynamic, 
                         vcov = "CR1",  # Cluster-robust type 1
                         cluster = attr(twfe_dir_dynamic$model, "index")[[1]])

results_CR2 <- coef_test(twfe_dir_dynamic, 
                         vcov = "CR2",  # Better small-sample properties
                         cluster = attr(twfe_dir_dynamic$model, "index")[[1]])

# View results
print(results_CR1)
print(results_CR2)
```


