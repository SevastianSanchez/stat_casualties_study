---
title: "Panel Analysis, Interaction Models (Two-Way FE and First Difference)"
author: "Sevastian Sanchez"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: no
    toc_depth: '3'
    number_sections: yes
  html_document:
    toc: no
    toc_depth: 3
    toc_float: yes
    number_sections: yes
    highlight: tango
    theme: default
    fig_caption: yes
    df_print: tibble
  word_document: default
  urlcolor: blue
---

```{r}
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE,
  tidy = TRUE, tidy.opts = list(width.cutoff = 60) 
)
```

## LOAD DATA AND REGIME CHANGE FUNCTION
```{r}
# set working directory
setwd("~/Documents/GitHub/stat_casualties_study")

#load libraries/packages
source("packages.R")

# load data
source("Comp2_panel_wrangling.R")

# load custom function for regime change variables [MUST LOAD BEFORE DATA]
source("wrangling/creating_regime_variables/identify_regime_change_main.R")

# Regime Change Identification Function [using EIU classifications]
panel_data_reg_eps <- identify_regime_change(panel_data)
```

## CHECKING REGIME CHANGE VARIABLES
```{r}
# Check results for specific countries [EXAMPLES]
panel_data_reg_eps %>%
  filter(country_code %in% c("HUN", "TUR", "POL")) %>%
  select(country_name, year, di_score, di_reg_cat, di_reg_cat_lag1,
         regime_changed, regime_change_direction, eiu_aut_ep, eiu_aut_ep_ext) %>%
  print(n = 50)

# Summary of transitions
panel_data_reg_eps %>%
  filter(regime_changed == 1) %>%
  group_by(country_name, year) %>%
  summarize(
    from = first(di_reg_cat_lag1),
    to = first(di_reg_cat),
    direction = first(regime_change_direction),
    .groups = "drop"
  ) %>%
  arrange(year, country_name)
```

## TWO-WAY FIXED EFFECTS MODELS WITH INTERACTIONS AND LAGS (k=2) 
**[SUBSET: DEMOCRACIES]**
```{r}
# set as pdata.frame
panel_data_reg_eps <- pdata.frame(panel_data_reg_eps, 
                                  index = c("country_code", "year"))
pdim(panel_data_reg_eps) # check panel dimensions

## STAGE I 
fe_s1_interact <- plm(
  formula = spi_comp ~ di_score * factor(eiu_aut_ep_ext) 
  + lag(di_score, 1) * factor(eiu_aut_ep)
  + lag(di_score, 2) * factor(eiu_aut_ep)
  + log_gdppc 
  + factor(year),
  data = panel_data_reg_eps,
  subset = di_score > 6,
  model = "within"
)
summary(fe_s1_interact, 
        vcov = vcovHC(fe_s1_interact, cluster = "group", type = "HC1"))

## STAGE II: Direct Effect (DI → SDG, no mediator)
fe_s2_dir_interact <- plm(
  formula = sdg_overall ~ di_score * factor(eiu_aut_ep)
  + lag(di_score, 1) * factor(eiu_aut_ep)
  + lag(di_score, 2) * factor(eiu_aut_ep)
  + log_gdppc 
  + factor(year),
  data = panel_data_reg_eps,
  subset = di_score > 6,
  model = "within"
)
summary(fe_s2_dir_interact, 
        vcov = vcovHC(fe_s2_dir_interact, cluster = "group", type = "HC1"))

## STAGE II: Mediation Effect (DI → SDG, SPI mediator)
fe_s2_med_interact <- plm(
  formula = sdg_overall ~ spi_comp * factor(eiu_aut_ep)
  + lag(spi_comp, 1) * factor(eiu_aut_ep)
  + lag(spi_comp, 2) * factor(eiu_aut_ep)
  + di_score * factor(eiu_aut_ep)
  + lag(di_score, 1) * factor(eiu_aut_ep)
  + lag(di_score, 2) * factor(eiu_aut_ep)
  + log_gdppc 
  + factor(year), 
  data = panel_data_reg_eps,
  subset = di_score > 6,
  model = "within"
)
summary(fe_s2_med_interact, 
        vcov = vcovHC(fe_s2_med_interact, cluster = "group", type = "HC1"))
```

## FIRST DIFFERENCE MODELS WITH INTERACTIONS AND LAGS (k=2)
**[SUBSET: DEMOCRACIES]**
```{r}
## STAGE I 
fd_s1_interact <- plm(
  formula = spi_comp ~ di_score * factor(eiu_aut_ep_ext) 
  + lag(di_score, 1) * factor(eiu_aut_ep)
  + lag(di_score, 2) * factor(eiu_aut_ep)
  + log_gdppc 
  + factor(year),
  data = panel_data_reg_eps,
  subset = di_score > 6,
  model = "fd"
)
summary(fd_s1_interact, 
        vcov = vcovHC(fd_s1_interact, cluster = "group", type = "HC1"))

## STAGE II: Direct Effect (DI → SDG, no mediator)
fd_s2_dir_interact <- plm(
  formula = sdg_overall ~ di_score * factor(eiu_aut_ep)
  + lag(di_score, 1) * factor(eiu_aut_ep)
  + lag(di_score, 2) * factor(eiu_aut_ep)
  + log_gdppc 
  + factor(year),
  data = panel_data_reg_eps,
  subset = di_score > 6,
  model = "fd"
)
summary(fd_s2_dir_interact, 
        vcov = vcovHC(fd_s2_dir_interact, cluster = "group", type = "HC1"))

## STAGE II: Mediation Effect (DI → SDG, SPI mediator)
fd_s2_med_interact <- plm(
  formula = sdg_overall ~ spi_comp * factor(eiu_aut_ep)
  + lag(spi_comp, 1) * factor(eiu_aut_ep)
  + lag(spi_comp, 2) * factor(eiu_aut_ep)
  + di_score * factor(eiu_aut_ep)
  + lag(di_score, 1) * factor(eiu_aut_ep)
  + lag(di_score, 2) * factor(eiu_aut_ep)
  + log_gdppc 
  + factor(year), 
  data = panel_data_reg_eps,
  subset = di_score > 6,
  model = "fd"
)
summary(fd_s2_med_interact, 
        vcov = vcovHC(fd_s2_med_interact, cluster = "group", type = "HC1"))
```

## SOME INSIGHTS 

TWFE MODELS:
- SPI ~ DI x aut_ep [not significant]  
- SDG ~ DI x aut_ep [significant]  
- SDG ~ SPI x aut_ep [significant]  
- Mediation effect varies by aut_ep status for democracies

FD MODELS:
- SPI ~ DI x aut_ep [marginally significant]  
- SDG ~ DI x aut_ep [not significant]  
- SDG ~ SPI x aut_ep [significant]  
- Mediation effect varies by aut_ep status for democracies

